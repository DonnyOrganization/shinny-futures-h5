<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: gap://ready http: https: https://appficaos.cfmmc.com https://www.gstatic.com 'unsafe-eval' ws: wss:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; media-src;">
    <title>众期货</title>
    <!-- manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- css -->
    <link href="css/ionic.app.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>

<body ng-app="starter" class="body-dark" style="background-color: #222">

    <ion-nav-view>
    </ion-nav-view>

    <script type="text/ng-template" id='menus.html'>
        <ion-side-menus enable-menu-with-back-views="true">
            <ion-side-menu-content drag-content="false">
                <ion-nav-view></ion-nav-view>
            </ion-side-menu-content>
            <ion-side-menu side="left">
                <ion-content style="padding-top: 44px">
                    <div class="list list-borderless">
                        <!--<a menu-toggle class="item item-icon-left item-dark" href="#/app/tabs/home">
                    <i class="icon ion-home"></i> 首页
                </a>-->
                        <a menu-toggle class="item item-icon-left item-dark" href="#/app/tabs/quote">
                            <i class="icon ion-arrow-graph-up-right"></i> 行情
                        </a>
                        <a menu-toggle class="item item-icon-left item-dark" href="#/app/tabs/position">
                            <i class="icon ion-person"></i> 账户
                        </a>
                        <a menu-toggle class="item item-icon-left item-dark" href="#/app/tabs/transaction">
                            <i class="icon ion-folder"></i> 历史
                        </a>
                        <a menu-toggle class="item item-icon-left item-dark" href="#/app/banktransfer">
                            <i class="icon ion-arrow-swap"></i> 银期转账
                        </a>
                        <a menu-toggle class="item item-icon-left item-dark" onclick="location.reload()">
                            <i class="icon ion-wand"></i> 系统更新
                        </a>
                        <!--<a menu-toggle class="item item-icon-left item-dark" href="#/app/tabs/community">
                    <i class="icon ion-chatboxes"></i> 公会
                </a>-->
                        <!--<div class="item"></div>
                <a menu-toggle class="item item-icon-left item-dark" href="#/app/feedback">
                    <i class="icon ion-reply"></i> 反馈
                </a>-->
                        <!--<a menu-toggle class="item item-icon-left item-dark" href="#/app/help">
                    <i class="icon ion-help-circled"></i> 帮助
                </a>-->
                    </div>
                </ion-content>
            </ion-side-menu>
        </ion-side-menus>
    </script>

    <script type="text/ng-template" id='tabs.html'>
        <ion-tabs class="tabs-icon-top tabs-dark tabs-color-mark">
            <!--<ion-tab title="首页" icon-off="ion-ios-home-outline" icon-on="ion-ios-home" href="#/app/tabs/home">
        <ion-nav-view name="tab-home"></ion-nav-view>
    </ion-tab>-->
            <ion-tab title="行情" icon-off="ion-ios-pulse" icon-on="ion-ios-pulse-strong" href="#/app/tabs/quote">
                <ion-nav-view name="tab-quote"></ion-nav-view>
            </ion-tab>
            <ion-tab title="账户" icon-off="ion-ios-person-outline" icon-on="ion-ios-person" href="#/app/tabs/position">
                <ion-nav-view name="tab-position"></ion-nav-view>
            </ion-tab>
            <ion-tab title="历史" icon-off="ion-ios-clock-outline" icon-on="ion-ios-clock" href="#/app/tabs/transaction">
                <ion-nav-view name="tab-transaction"></ion-nav-view>
            </ion-tab>
            <!--<ion-tab title="圈子" icon-off="ion-ios-people-outline" icon-on="ion-ios-people" href="#/app/tabs/community">
        <ion-nav-view name="tab-community"></ion-nav-view>
    </ion-tab>-->
        </ion-tabs>
    </script>


    <!-- js -->
    <script src="lib/zepto.min.js" type="text/javascript"></script>
    <script src="lib/moment.js" type="text/javascript"></script>
    <script src="zqjs/datamanager.js"></script>
    <script src="zqjs/baseService.js" type="text/javascript"></script>
    <script src="zqjs/websocket.js"></script>
    <!--<script src="lib/NIM_Web_SDK_v3.2.0.js"></script>
    <script src="zqjs/chat.js"></script>-->
    <!-- ionic/angularjs js -->
    <script src="lib/ionic/js/ionic.bundle.js"></script>
    <!-- lib -->
    <script src="lib/datetime.js"></script>
    <script src="lib/three.js"></script>
    <script src="lib/CanvasRenderer.js"></script>
    <script src="lib/Projector.js"></script>
    <script src="lib/ionic-datepicker.bundle.min.js"></script>
    <!-- chart -->
    <script src="zqjs/charts/chart3D.js"></script>
    <script src="zqjs/charts/chartset.js"></script>
    <script src="zqjs/charts/chart.js"></script>
    <script src="zqjs/configuration.js"></script>
    <!-- draws -->
    <script src="zqjs/draws/Draw_Quote.js"></script>
    <script src="zqjs/draws/Draw_Postion.js"></script>
    <script src="zqjs/draws/Draw_Makeorder.js"></script>
    <script src="zqjs/draws/Draw_Posdetail.js"></script>
    <script src="zqjs/draws/Draw_App.js"></script>
    <!-- cordova -->
    <script src="cordova.js"></script>
    <!-- your app's js -->
    <!--<script src="zqjs/app.js"></script>-->
    <script>
        angular.module('starter', ['ionic', 'datetime', 'ionic-datepicker', 'starter.controllers', 'starter.services', 'numericKeyboard'])

        .run(['$rootScope', '$state', '$urlRouter', '$interval', '$timeout', '$location', '$ionicModal', '$ionicLoading', '$ionicHistory', '$ionicPlatform', 'LoginService', '$http',
            function($rootScope, $state, $urlRouter, $interval, $timeout, $location, $ionicModal, $ionicLoading, $ionicHistory, $ionicPlatform, LoginService, $http) {
                // init
                // 1. init http headers
                $http.defaults.headers.common['Content-Type'] = 'application/json;charset=utf-8';
                $http.defaults.headers.common['Accept'] = 'application/json';
                if (localStorage.getItem('Shinny-Session')) {
                    $http.defaults.headers.common['Shinny-Session'] = localStorage.getItem('Shinny-Session');
                }

                // 2. datamanager init
                DM.init(draw_app);
                // InstrumentManager.init();

                // 全局设置 angularui-router . state
                $rootScope.$state = $state;

                // 登录状态
                $rootScope.login_states = {
                    type: 'none',
                    broker_id: '',
                };

                // 登录参数 
                $rootScope.login_params = {
                    type: 'sim',
                };

                if (localStorage.getItem('mobile')) {
                    $rootScope.login_states.mobile = localStorage.getItem('mobile') ? localStorage.getItem('mobile') : '';
                }

                // 初始化注册开户页面显示内容 [one, two.onlysim, two.all, two.no]
                $rootScope.register_step = 'one';

                // 初始化生成 $rootScope.registerModal $rootScope.changepwdModal
                $ionicModal.fromTemplateUrl('templates/modals/register.html', {
                    scope: $rootScope,
                    animation: 'slide-in-up',
                    hardwareBackButtonClose: false
                }).then(function(modal) {
                    $rootScope.registerModal = modal;
                });
                $ionicModal.fromTemplateUrl('templates/modals/changepwd.html', {
                    scope: $rootScope,
                    animation: 'slide-in-up',
                    hardwareBackButtonClose: false
                }).then(function(modal) {
                    $rootScope.changepwdModal = modal;
                });

                /**
                 * parameters
                 * $rootScope.login_states.mobile - 手机号码
                 * $rootScope.login_states.sim_password - 模拟密码
                 * $rootScope.login_states.account - 实盘账户
                 * $rootScope.login_states.act_password - 实盘密码
                 * $rootScope.login_error - 登录是否出错
                 * $rootScope.login_error_msg - 登录错误提示
                 */

                /**
                 * functions
                 * $rootScope.closeModal - 关闭 2 个 modal
                 * $rootScope.setParams - 根据登录状态设置登录参数
                 * $rootScope.switchParams - 切换登录参数 sim/act
                 * $rootScope.do_login - 登录
                 * $rootScope.do_register - 注册
                 * $rootScope.do_checkmobile - 检查手机号
                 * $rootScope.do_changepwd -  修改密码
                 */
                $rootScope.closeModal = function() {
                    if ($rootScope.registerModal.isShown()) {
                        $rootScope.registerModal.hide();
                    }
                    if ($rootScope.changepwdModal.isShown()) {
                        $rootScope.changepwdModal.hide();
                    }
                    return;
                };

                $rootScope.checkMobile = function() {
                    console.log($rootScope.login_states.mobile);
                    localStorage.setItem('mobile', $rootScope.login_states.mobile);
                    LoginService.do_http_mobilestatus($rootScope.login_states.mobile)
                        .then(function(response) {
                            if (response.status == 200) {
                                console.log(response.data)
                                if (response.data.sim_account == 0) {
                                    $rootScope.register_step = 'two.no';
                                    //无模拟无实盘
                                    LoginService.do_http_register({
                                            "mobile": $rootScope.login_states.mobile
                                        })
                                        .then(function(response) {
                                            if (response.status == 201) {
                                                $rootScope.register_step = 'two.no';
                                            } else {
                                                console.log('注册失败')
                                            }
                                        });
                                } else if (response.data.real_account == 0) {
                                    //有模拟无实盘
                                    $rootScope.register_step = 'two.onlysim';
                                } else {
                                    //有模拟有实盘
                                    $rootScope.register_step = 'two.all';
                                }
                                console.log($rootScope.register_step)
                            } else {
                                console.log(response.status)
                            }
                        });

                }

                $rootScope.openAccount = function() {
                    // 东方期货 0127  浏览器&registerWay=2
                    var m = $rootScope.login_states.mobile;
                    window.location.href = 'https://appficaos.cfmmc.com/indexnew?brokerId=0127&openType=9&checkBrokerIdFlag=false&mobile=' + m;
                }

                $rootScope.register = function() {
                    LoginService.do_register();
                }

                $rootScope.send_pwd = function() {
                    var broker_id = "";
                    if ($rootScope.login_params.type == 'sim') {
                        broker_id = $rootScope.login_params.type;
                    }
                    var d = {
                        "broker_id": broker_id,
                        "mobile": $rootScope.login_states.mobile
                    };

                    LoginService.do_http_resetPassword(d).then(function(response) {
                        if (response.status == 200) {
                            $rootScope.send_pwd_message_result = true;
                            $rootScope.send_pwd_message = "重置成功，密码发送到您手机。";
                            localStorage.setItem('mobile', $rootScope.login_states.mobile);
                        } else if (response.status == 403) {
                            $rootScope.send_pwd_message_result = true;
                            $rootScope.send_pwd_message = "该手机号未注册。";
                        } else {
                            $rootScope.send_pwd_message_result = true;
                            $rootScope.send_pwd_message = "服务器正忙,请稍后重试!";
                        }
                    }, function(response) {
                        if (response.status == 403) {
                            $rootScope.send_pwd_message_result = true;
                            $rootScope.send_pwd_message = "该手机号未注册。";
                        }
                    });
                }


                $ionicPlatform.ready(function() {
                    if (window.StatusBar) {
                        // org.apache.cordova.statusbar required
                        StatusBar.backgroundColorByHexString("#222222");
                        StatusBar.styleLightContent();
                    }

                    InstrumentManager.init();

                    // init websocket
                    // WS.init(SETTING.sim_server_url);
                    if (LoginService.last_login_state() == "sim" || LoginService.last_login_state() == "none") {
                        WS.init(SETTING.sim_server_url);
                    } else {
                        WS.init(SETTING.act_server_url);
                    }

                    document.addEventListener("offline", function() {
                        window.plugins.toast.showWithOptions({
                            message: "请检查网络连接",
                            duration: "long",
                            position: "bottom",
                            addPixelsY: -40
                        });
                    }, false);
                });
            }
        ])

        .config(['$stateProvider', '$urlRouterProvider', '$httpProvider', '$ionicConfigProvider', 'ionicDatePickerProvider',
                function($stateProvider, $urlRouterProvider, $httpProvider, $ionicConfigProvider, ionicDatePickerProvider) {

                    var datePickerObj = {
                        inputDate: new Date(),
                        titleLabel: '请选择日期',
                        setLabel: '选择',
                        todayLabel: '今天',
                        closeLabel: '关闭',
                        mondayFirst: false,
                        weeksList: ["周日", "周一", "周二", "周三", "周四", "周五", "周六"],
                        monthsList: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
                        templateType: 'popup',
                        from: new Date(2010, 1, 1),
                        to: new Date(),
                        showTodayButton: true,
                        dateFormat: 'yyyy MM dd',
                        closeOnSelect: false,
                        disableWeekdays: [0, 6]
                    };

                    ionicDatePickerProvider.configDatePicker(datePickerObj);

                    $urlRouterProvider.otherwise('/app/tabs/quote');

                    $stateProvider
                        .state('app', {
                            url: '/app',
                            abstract: true,
                            templateUrl: 'menus.html',
                        })
                        .state('app.tabs', {
                            url: '/tabs',
                            abstract: true,
                            templateUrl: 'tabs.html',
                        })
                        //  主页
                        // .state('app.tabs.home', {
                        //     url: '/home',
                        //     views: {
                        //         'tab-home': {
                        //             templateUrl: 'templates/home.html',
                        //             controller: 'HomeCtrl'
                        //         }
                        //     }
                        // })
                        // 报价
                        .state('app.tabs.quote', {
                            url: '/quote',
                            views: {
                                'tab-quote': {
                                    templateUrl: 'templates/quote.html',
                                    controller: 'QuoteCtrl'
                                }
                            }
                        })
                        // 持仓
                        .state('app.tabs.position', {
                            url: '/position',
                            views: {
                                'tab-position': {
                                    templateUrl: 'templates/position.html',
                                    controller: 'PositionCtrl'
                                }
                            }
                        })
                        // 交易历史
                        .state('app.tabs.transaction', {
                            url: '/transaction',
                            views: {
                                'tab-transaction': {
                                    templateUrl: 'templates/transaction.html',
                                    controller: 'TransactionCtrl'
                                }
                            }
                        })
                        // 圈子
                        .state('app.tabs.community', {
                            url: '/community',
                            views: {
                                'tab-community': {
                                    templateUrl: 'templates/community.html',
                                    controller: 'CommunityCtrl'
                                }
                            }
                        })
                        /***************************/
                        // 持仓详情
                        .state('app.posdetail', {
                            url: '/posdetail',
                            templateUrl: 'templates/posdetail.html',
                            controller: 'PosdetailCtrl'
                        })
                        // 交易
                        .state('app.makeorder', {
                            url: '/makeorder',
                            templateUrl: 'templates/makeorder.html',
                            controller: 'MakeorderCtrl'
                        })
                        // 银期转账
                        .state('app.banktransfer', {
                            url: '/banktransfer',
                            templateUrl: 'templates/banktransfer.html',
                            controller: 'BanktransferCtrl'
                        })
                        // 个人信息-登录状态
                        .state('app.userinfo', {
                            url: '/userinfo',
                            templateUrl: 'templates/userinfo.html',
                            controller: 'UserinfoCtrl'
                        })
                        // 反馈
                        // .state('app.feedback', {
                        //     url: '/feedback',
                        //     templateUrl: 'templates/feedback.html',
                        //     controller: 'UserinfoCtrl'
                        // })
                        // 帮助
                        // .state('app.help', {
                        //     url: '/help',
                        //     templateUrl: 'templates/help.html',
                        //     controller: 'UserinfoCtrl'
                        // });

                    $ionicConfigProvider.views.swipeBackEnabled(false);
                    $ionicConfigProvider.views.transition('none');
                    $ionicConfigProvider.navBar.alignTitle('center');

                    // note that you can also chain configs
                    $ionicConfigProvider.backButton.text('').icon('ion-ios-arrow-thin-left').previousTitleText(false)

                    $ionicConfigProvider.tabs.style('standard');
                    $ionicConfigProvider.tabs.position('bottom');

                    $httpProvider.interceptors.push(function() {
                        return {
                            'request': function(config) {
                                if (config.url.indexOf("api.shinnytech.com/") > 0 && navigator && navigator.connection && Connection) {
                                    var networkState = navigator.connection.type;
                                    switch (networkState) {
                                        case Connection.UNKNOWN:
                                        case Connection.NONE:
                                            navigator.notification.alert(
                                                '未连接网络',
                                                function() {
                                                    return;
                                                },
                                                '提示',
                                                '确定'
                                            );
                                            break;
                                        case Connection.ETHERNET:
                                        case Connection.WIFI:
                                        case Connection.CELL_2G:
                                        case Connection.CELL_3G:
                                        case Connection.CELL_4G:
                                        case Connection.CELL:
                                        default:
                                    }
                                }
                                return config;
                            }
                        };
                    });
                }
            ])
            .constant('regObj', {
                inout: {
                    reg: /[入|出]金/,
                    rule: true
                },
                close: {
                    reg: /平仓/,
                    rule: true
                },
                others: {
                    reg: /[平仓|金]/,
                    rule: false
                },
            })
            .filter('toShow', ['regObj', function(regObj) {
                return filter = function(array, para) {
                    var arr = angular.copy(array);
                    var reg = regObj[para].reg;
                    for (var i = 0; i < arr.length; i++) {
                        var s = JSON.stringify(arr[i].actions);
                        if (regObj[para].rule) {
                            if (!reg.test(s)) {
                                arr.splice(i--, 1);
                            }
                        } else {
                            if (reg.test(s)) {
                                arr.splice(i--, 1);
                            }
                        }
                    }
                    return arr;
                };
            }]);

        angular.module('starter.controllers', []);
    </script>
    <!-- inject:js -->
    <!-- endinject -->
    <script src="zqjs/numericKeyboard.js"></script>
    <!--<script src="zqjs/ctrls/Ctrl_App.js"></script>-->
    <!--<script src="zqjs/ctrls/Ctrl_Home.js"></script>-->
    <script src="zqjs/ctrls/Ctrl_Posdetail.js"></script>
    <script src="zqjs/ctrls/Ctrl_Position.js"></script>
    <script src="zqjs/ctrls/Ctrl_Quote.js"></script>
    <script src="zqjs/ctrls/Ctrl_Transaction.js"></script>
    <script src="zqjs/ctrls/Ctrl_Community.js"></script>
    <script src="zqjs/ctrls/Ctrl_Makeorder.js"></script>
    <script src="zqjs/ctrls/Ctrl_Banktransfer.js"></script>
    <script src="zqjs/ctrls/Ctrl_Userinfo.js"></script>
    <!--<script src="zqjs/ctrls/Ctrl_Feedback.js"></script>
    <script src="zqjs/ctrls/Ctrl_Help.js"></script>-->
    <script src="zqjs/services.js"></script>
    <script src="zqjs/directives.js"></script>
</body>

</html>